<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
  <head>
    <title>Interactive dataviz on the web with R, plotly, and shiny</title>
    <meta charset="utf-8" />
    <meta name="author" content="Carson Sievert" />
    <link href="index_files/remark-css-0.0.1/default.css" rel="stylesheet" />
    <link href="index_files/remark-css-0.0.1/default-fonts.css" rel="stylesheet" />
    <link rel="stylesheet" href="main.css" type="text/css" />
  </head>
  <body>
    <textarea id="source">
class: center, middle, inverse, title-slide

# Interactive dataviz on the web with R, plotly, and shiny
### Carson Sievert

---

class: inverse, middle
background-image: url(your-turn.jpeg)
background-size: contain

&lt;style&gt;
.principles {
  font-size: 150%;
}
&lt;/style&gt;

&lt;h2 align="center"&gt; Your turn &lt;/h2&gt;

(1) Go to this address &lt;https://rstudio.cloud/project/14090&gt;. Follow the directions you see in the 'hello.R' script.

(2) Share (w/ your neighbor) 3 things you're hoping to take away from this workshop

.footnote[
---
Time: 5 minutes
]



---
## A minimal bar chart

* Every **plotly** chart is powered by [plotly.js](https://github.com/plotly/plotly.js), *plus some extra R/JS magic* üé© üê∞.
* `plot_ly()` is designed to give more "R-like" defaults


```r
library(plotly)
plot_ly(x = c("A", "B"), y = 1:2)
```

&lt;iframe src="01-simple-bar.html" width="100%" height="300" scrolling="no" seamless="seamless" frameBorder="0"&gt; &lt;/iframe&gt;

What actually happens when a plotly object is printed and rendered locally?

---
class: inverse
background-image: url(printing.svg)
background-size: contain

---

## A plotly.js bar chart

.pull-left[
```js
var trace1 = {
  x: ['giraffes', 'orangutans', 'monkeys'],
  y: [20, 14, 23],
  name: 'SF Zoo',
  type: 'bar'
};

var trace2 = {
  x: ['giraffes', 'orangutans', 'monkeys'],
  y: [12, 18, 29],
  name: 'LA Zoo',
  type: 'bar'
};

var data = [trace1, trace2];

Plotly.newPlot('myDiv', data);
```
]

.pull-right[
&lt;img src="zoo-bars.png" width="100%"/&gt;
]

---
## Now, with `plot_ly()`

.pull-left[
```r
plot_ly() %&gt;%
  add_trace(
    x = c('giraffes', 'orangutans', 'monkeys'),
    y = c(20, 14, 23),
    name = 'SF Zoo',
    type = 'bar'
  ) %&gt;%
  add_trace(
    x = c('giraffes', 'orangutans', 'monkeys'),
    y = c(12, 18, 29),
    name = 'LA Zoo',
    type = 'bar'
  )
```
]

.pull-right[
&lt;img src="zoo-bars.png" width="100%"/&gt;
]

**Important**: You can *always* work at the plotly.js level with `plot_ly()` (as done here), but you don't have to!

---
## `plot_ly()` makes it easier to work with data

.pull-left[
```r
zoo_dat &lt;- tibble::tibble(
  animal = rep(c('giraffes', 'orangutans', 'monkeys'), 2),
  count = c(20, 14, 23, 12, 18, 29),
  zoo = rep(c('SF Zoo', 'LA Zoo'), each = 3)
)
plot_ly(zoo_dat) %&gt;%
  add_bars(
    x = ~animal,
    y = ~count,
    name = ~zoo
  )
```
]

.pull-right[
&lt;img src="zoo-bars.png" width="100%"/&gt;
]

---
## `plot_ly()` makes it easier to work with data

.pull-left[
```r
zoo_dat &lt;- tibble::tibble(
  animal = rep(c('giraffes', 'orangutans', 'monkeys'), 2),
  count = c(20, 14, 23, 12, 18, 29),
  zoo = rep(c('SF Zoo', 'LA Zoo'), each = 3)
)
plot_ly(zoo_dat) %&gt;%
  add_bars(
*   x = ~animal,
*   y = ~count,
*   name = ~zoo
  )
```
]

.pull-right[
&lt;img src="zoo-bars.png" width="100%"/&gt;
]

If you want to reference a data column, you must use `~`

---
## `plot_ly()` makes it easier to work with data

.pull-left[
```r
zoo_dat &lt;- tibble::tibble(
  animal = rep(c('giraffes', 'orangutans', 'monkeys'), 2),
  count = c(20, 14, 23, 12, 18, 29),
  zoo = rep(c('SF Zoo', 'LA Zoo'), each = 3)
)
plot_ly(zoo_dat) %&gt;%
  add_bars(
    x = ~animal,
    y = ~count,
*   name = ~zoo
  )
```
]

.pull-right[
&lt;img src="zoo-bars.png" width="100%"/&gt;
]

For some attributes like `name`, `color`, etc, `plot_ly()` will generate one trace per level for you (if makes sense to).

---
## `plot_ly()` makes it easier to map data to visuals

.pull-left[
```r
zoo_dat &lt;- tibble::tibble(
  animal = rep(c('giraffes', 'orangutans', 'monkeys'), 2),
  count = c(20, 14, 23, 12, 18, 29),
  zoo = rep(c('SF Zoo', 'LA Zoo'), each = 3)
)
plot_ly(zoo_dat) %&gt;%
  add_bars(
    x = ~animal,
    y = ~count,
*   color = ~zoo
  )
```
]

.pull-right[
&lt;img src="zoo-bars-color.png" width="100%"/&gt;
]

Mapping data to `color` will impose it's own color scheme

---
## `plot_ly()` makes it easier to map data to visuals

.pull-left[
```r
zoo_dat &lt;- tibble::tibble(
  animal = rep(c('giraffes', 'orangutans', 'monkeys'), 2),
  count = c(20, 14, 23, 12, 18, 29),
  zoo = rep(c('SF Zoo', 'LA Zoo'), each = 3)
)
plot_ly(zoo_dat) %&gt;%
  add_bars(
    x = ~animal,
    y = ~count,
*   color = ~zoo,
*   colors = "Accent"
  )
```
]

.pull-right[
&lt;img src="zoo-bars-color-accent.png" width="100%"/&gt;
]

Specify the range via `colors` (here a [colorbrewer](http://colorbrewer2.org) palette name, see `RColorBrewer::brewer.pal.info` for options)

---
## `plot_ly()` makes it easier to map data to visuals

.pull-left[
```r
zoo_dat &lt;- tibble::tibble(
  animal = rep(c('giraffes', 'orangutans', 'monkeys'), 2),
  count = c(20, 14, 23, 12, 18, 29),
  zoo = rep(c('SF Zoo', 'LA Zoo'), each = 3)
)
plot_ly(zoo_dat) %&gt;%
  add_bars(
    x = ~animal,
    y = ~count,
*   color = ~zoo,
*   colors = c(
*     "SF Zoo" = "black", 
*     "LA Zoo" = "red"
*   )
  )
```
]

.pull-right[
&lt;img src="zoo-bars-color-manual.png" width="100%"/&gt;
]

Provide your own palette if you want. See `?plot_ly` for more details.

---
## `plot_ly()` makes it easier to work with data

.pull-left[
```r
zoo_dat &lt;- tibble::tibble(
  animal = rep(c('giraffes', 'orangutans', 'monkeys'), 2),
  count = c(20, 14, 23, 12, 18, 29),
  zoo = rep(c('SF Zoo', 'LA Zoo'), each = 3)
)
plot_ly(zoo_dat) %&gt;%
  add_bars(
    x = ~animal,
    y = ~count,
    split = ~zoo,
*   stroke = ~zoo,
*   strokes = c(
*     "SF Zoo" = "black", 
*     "LA Zoo" = "red"
*   )
  )
```
]

.pull-right[
&lt;img src="zoo-bars-stroke.png" width="100%"/&gt;
]

* `color`/`colors` for fill-color
* `stroke`/`strokes` for outline-color

---
class: inverse, middle
background-image: url(your-turn.jpeg)
background-size: contain

## Your turn

.pull-left[
```r
zoo_dat &lt;- tibble::tibble(
  animal = rep(c('giraffes', 'orangutans', 'monkeys'), 2),
  count = c(20, 14, 23, 12, 18, 29),
  zoo = rep(c('SF Zoo', 'LA Zoo'), each = 3)
)
plot_ly(zoo_dat) %&gt;%
  add_bars(
    x = ~animal,
    y = ~count,
    color = ~zoo,
    stroke = "black",
    span = I(5)
  )
```
]

.pull-right[
&lt;img src="zoo-bars-stroke-broken.png" width="100%"/&gt;
]

1. What does the `span` argument control? 
2. Can you make the `span` be a function of `count`?
3. Why isn't the `stroke` on this plot black?

---
## Use `plotly_json()` to see the underlying JSON

.pull-left[
```r
plot_ly(diamonds, y = ~cut, color = ~clarity, stroke = I("black"))
```

&lt;iframe src="diamonds.html" width="150%" height="500" id="igraph" scrolling="no" seamless="seamless" frameBorder="0"&gt; &lt;/iframe&gt;
]

.pull-right[
```r
# If no plot is provided, it shows JSON of the previously printed plot
plotly_json()
```

&lt;iframe src="diamonds-json.html" width="100%" height="400" id="igraph" scrolling="no" seamless="seamless" frameBorder="0"&gt; &lt;/iframe&gt;
]

---
## Use `schema()` to see what's available

```r
schema()
```

&lt;iframe src="schema.html" width="120%" height="450" id="igraph" scrolling="no" seamless="seamless" frameBorder="0"&gt; &lt;/iframe&gt;

---
### `schema()` is especially useful for `layout()`/`config()`


.pull-left[
```r
plot_ly() %&gt;%
  layout(
    xaxis = list(range = c(-5, 5)),
    yaxis = list(range = c(-5, 5)),
    # shapes types: rect, circle, line
    shapes = list(
      type = "rect",
      x0 = 0, x1 = 1, 
      y0 = 0, y1 = -1,
      fillcolor = "blue"
    ),
    annotations = list(
      text = "Drag the rect",
      x = 0.5, xref = "paper",
      y = 0.5, yref = "paper"
    )
  ) %&gt;%
  config(
    editable = TRUE,
    displayModeBar = FALSE
  )
```
]

.pull-right[
&lt;iframe src="editable.html" width="110%" height="550" id="igraph" scrolling="no" seamless="seamless" frameBorder="0"&gt; &lt;/iframe&gt;
]

---
## Examples of editable charts

&lt;div align="center"&gt;
&lt;iframe src="https://player.vimeo.com/video/309371928?title=0&amp;byline=0&amp;portrait=0" width="640" height="446" frameborder="0" allow="autoplay; fullscreen" allowfullscreen&gt;&lt;/iframe&gt;
&lt;/div&gt;

---
## Examples of editable charts

&lt;div align="center"&gt;
&lt;iframe src="https://player.vimeo.com/video/318338029?title=0&amp;byline=0&amp;portrait=0" width="640" height="446" frameborder="0" allow="autoplay; fullscreen" allowfullscreen&gt;&lt;/iframe&gt;
&lt;/div&gt;

---
background-image: url(https://talks.cpsievert.me/20180515/server-client.svg)
background-size: contain
class: middle, right

# When is a web application necessary?

---
background-image: url(https://talks.cpsievert.me/20180515/server-client-dim.svg)
background-size: contain
class: middle, right

# Easier to share, scale, and maintain

---
background-image: url(https://talks.cpsievert.me/20180515/server-client-dim.svg)
background-size: contain
class: middle, right

# What can plotly do in a standalone page?

---
## Quite a bit out-of-the-box!

&lt;div align="center"&gt;
&lt;iframe src="https://player.vimeo.com/video/315707813?title=0&amp;byline=0&amp;portrait=0" width="640" height="446" frameborder="0" allow="autoplay; fullscreen" allowfullscreen&gt;&lt;/iframe&gt;
&lt;/div&gt;

More sophisticated or custom behavior takes a bit of work

---
class: principles, inverse

&lt;h2 align="center"&gt; plotly's &lt;i&gt;client-side&lt;/i&gt; reactivity options &lt;/h2&gt;

1. Graphical (database) queries
  * In _plotly for R_, I call this [linking views without shiny](https://plotly-book.cpsievert.me/linking-views-without-shiny.html).
  
2. Respond to plotly [sliders](https://plot.ly/r/sliders/), [buttons](https://plot.ly/r/custom-buttons/), and [dropdowns](https://plot.ly/r/dropdowns/) via [plotly.js functions](https://plot.ly/javascript/plotlyjs-function-reference/)

3. Custom JavaScript via `htmlwidgets::onRender()`
  * Respond to [plotly.js events](https://plot.ly/javascript/plotlyjs-events/) in a custom way
  
---
class: principles, inverse

&lt;h2 align="center"&gt; plotly's &lt;i&gt;client-side&lt;/i&gt; reactivity options &lt;/h2&gt;

1. Graphical (database) queries
    * In _plotly for R_, I call this [linking views without shiny](https://plotly-book.cpsievert.me/linking-views-without-shiny.html).
  
.footnote[
I basically covered this last year, see here if this interests you https://plotly-book.cpsievert.me/linking-views-without-shiny.html
]

---
class: principles, inverse

&lt;h2 align="center"&gt; plotly's &lt;i&gt;client-side&lt;/i&gt; reactivity options &lt;/h2&gt;

1. Graphical (database) queries
  * In _plotly for R_, I call this [linking views without shiny](https://plotly-book.cpsievert.me/linking-views-without-shiny.html).
  
2. Respond to plotly [sliders](https://plot.ly/r/sliders/), [buttons](https://plot.ly/r/custom-buttons/), and [dropdowns](https://plot.ly/r/dropdowns/) via [plotly.js functions](https://plot.ly/javascript/plotlyjs-function-reference/)


  
.footnote[
Can be useful, but already well-documented and not great workshop material
]

---
class: principles, inverse

&lt;h2 align="center"&gt; plotly's &lt;i&gt;client-side&lt;/i&gt; reactivity options &lt;/h2&gt;

1. Graphical (database) queries
  * In _plotly for R_, I call this [linking views without shiny](https://plotly-book.cpsievert.me/linking-views-without-shiny.html).
  
2. Respond to plotly [sliders](https://plot.ly/r/sliders/), [buttons](https://plot.ly/r/custom-buttons/), and [dropdowns](https://plot.ly/r/dropdowns/) via [plotly.js functions](https://plot.ly/javascript/plotlyjs-function-reference/)
  
3. Custom JavaScript via `htmlwidgets::onRender()`
  * Respond to [plotly.js events](https://plot.ly/javascript/plotlyjs-events/) in a custom way
  
.footnote[
New book chapter on this!  https://plotly-r.com/javascript.html
]


---
class: inverse, middle, principles
background-image: url(your-turn.jpeg)
background-size: contain

&lt;h2 align="center"&gt; Your Turn &lt;/h2&gt;

Think of a question you'd like to answer using familiar data. Think of an interactive graphic that could help address the question (bonus: draw it)!

.footnote[
---

Time: 5 minutes
]

---

### openFDA drug outcomes

```r
library(openfda) # remotes::install_github("ropenhealth/openfda")
library(dplyr)
drug_outcomes &lt;- function(name) {
  fda_query("/drug/event.json") %&gt;%
    fda_filter("patient.drug.openfda.generic_name", name) %&gt;%
    fda_count("patient.reaction.reactionoutcome") %&gt;%
    fda_exec() %&gt;%
    mutate(reaction = recode(term,
        `1` = "Recovered/resolved",
        `2` = "Recovering/resolving",
        `3` = "Not recovered/not resolved",
        `4` = "Recovered/resolved with sequelae",
        `5` = "Fatal", `6` = "Unknown")) 
}
drug_outcomes("fentanyl")
#&gt;   term count                         reaction
#&gt; 1    5 31515                            Fatal
#&gt; 2    6 30624                          Unknown
#&gt; 3    1 14641               Recovered/resolved
#&gt; 4    3 13691       Not recovered/not resolved
#&gt; 5    2  4248             Recovering/resolving
#&gt; 6    4   406 Recovered/resolved with sequelae
```

---

### Visualizing outcomes for a few drugs

.pull-left[
```r
drugs &lt;- c(
  "fentanyl", 
  "oxycodone", 
  "morphine"
)

lapply(drugs, drug_outcomes) %&gt;%
  setNames(drugs) %&gt;%
  bind_rows(.id = "drug") %&gt;%
  plot_ly(
    y = ~reaction, 
    x = ~count, 
    color = ~drug
  ) %&gt;%
  add_bars()
```
]

.pull-right[
&lt;img src="drug-bars.png" /&gt;
]

---
## Same data, different look

.pull-left[
&lt;img src="drug-bars.png" /&gt;
]
.pull-right[
&lt;img src="drug-heat.png" /&gt;
]

---
### Heatmap of 1000 drug outcomes (made with heatmaply and plotly)

&lt;div align="center"&gt;
&lt;iframe src="https://player.vimeo.com/video/285132666?title=0&amp;byline=0&amp;portrait=0" width="640" height="446" frameborder="0" allow="autoplay; fullscreen" allowfullscreen&gt;&lt;/iframe&gt;
&lt;/div&gt;

---
### Finding 'unusual' patterns and sense-making

&lt;div align="center"&gt;
&lt;iframe src="https://player.vimeo.com/video/285119443?title=0&amp;byline=0&amp;portrait=0" width="640" height="446" frameborder="0" allow="autoplay; fullscreen" allowfullscreen&gt;&lt;/iframe&gt;
&lt;/div&gt;


---
class: center, middle

# Overview first, then zoom and filter, then details on demand 

Ben Shneiderman

.footnote[
Popular information visualization perspective
]

---
class: center, inverse, middle

# Visualization surprise, but don't scale well. Models scale well, but don't surprise

Hadley Wickham

.footnote[
Popular statistical graphics perspective
]


---
class: center, middle

# Accessing plotly user events

```r
shiny::runApp("~/tutorials/20190821/shiny/02", display.mode = "showcase")
```

---
class: inverse, middle
background-image: url(../your-turn.jpeg)
background-size: contain

&lt;h2 align="center"&gt; Your turn &lt;/h2&gt;

1. Modify the last app to use `plot_ly()` instead of `ggplotly()`

2. Add output blocks that print out data from the following events:

* `"plotly_hover"`
* `"plotly_click"`
* `"plotly_relayout"`

.footnote[
---

Time: 5 minutes
]


---
class: center, middle

# Targetting events

```r
shiny::runApp("~/tutorials/20190821/shiny/03", display.mode = "showcase")
```

.footnote[
See also &lt;https://plotly-book.cpsievert.me/linking-views-with-shiny.html#targeting-views&gt;
]

---
class: center, middle

# plotly proxies

By default, **shiny updates require a full redraw**, but proxies allows us to leverage [the plotly.js API](https://plot.ly/javascript/plotlyjs-function-reference/) to modify/update graphs more efficiently

```r
shiny::runApp("~/tutorials/20190821/shiny/04", display.mode = "showcase")
```

---
class: center, middle

# Streaming data

```r
shiny::runApp("~/tutorials/20190821/shiny/05", display.mode = "showcase")
```

.footnote[
Inspired by &lt;https://plot.ly/r/streaming/&gt;
]

---
class: inverse, middle
background-image: url(../your-turn.jpeg)
background-size: contain

&lt;h2 align="center"&gt; Your turn &lt;/h2&gt;

Open the last example 

```r
file.edit("~/workshops/20180609/day2/shiny/05/app.R")
```

Modify it to do the following:

1. Add `sliderInput()` for controlling the streaming interval.

2. Add a widgets to:
  * Change *only* the width of the line
  * Change *only* the color of the line
  * *Only* add/remove markers (e.g. points) for each data point

&lt;hr&gt;

Time: 10 minutes

Hint: some of these shiny example apps will be helpful (e.g. `proxy_restyle_economics`) -- &lt;https://github.com/ropensci/plotly/tree/master/inst/examples/shiny&gt;

---
class: inverse, center, middle
background-image: url(your-turn.jpeg)
background-size: contain


## Your turn

Remember [this](#28) "your turn"? Let's try to make that idea a reality!

---
background-image: url(plotly.svg)
background-size: 100px
background-position: 90% 8%
class: center, middle

# Thanks!

Resources for more learning:

https://plotly-r.com &lt;br /&gt;
https://plot.ly/r &lt;br /&gt;
https://talks.cpsievert.me &lt;br /&gt;
https://vimeo.com/cpsievert

Find me online:

Web: &lt;http://cpsievert.me/&gt; &lt;br /&gt;
Twitter: [@cpsievert](https://twitter.com/cpsievert) &lt;br /&gt;
GitHub: [@cpsievert](https://github.com/cpsievert) &lt;br /&gt;
Email: &lt;cpsievert1@gmail.com&gt;


---
class: middle, center

# Ask me anything!!
    </textarea>
<style data-target="print-only">@media screen {.remark-slide-container{display:block;}.remark-slide-scaler{box-shadow:none;}}</style>
<script src="libs/remark-latest.min.js"></script>
<script>var slideshow = remark.create({
"ratio": "14.6:9",
"highlightStyle": "github",
"highlightLines": true,
"countIncrementalSlides": false,
"navigation": {
"scroll": false
}
});
if (window.HTMLWidgets) slideshow.on('afterShowSlide', function (slide) {
  window.dispatchEvent(new Event('resize'));
});
(function(d) {
  var s = d.createElement("style"), r = d.querySelector(".remark-slide-scaler");
  if (!r) return;
  s.type = "text/css"; s.innerHTML = "@page {size: " + r.style.width + " " + r.style.height +"; }";
  d.head.appendChild(s);
})(document);

(function(d) {
  var el = d.getElementsByClassName("remark-slides-area");
  if (!el) return;
  var slide, slides = slideshow.getSlides(), els = el[0].children;
  for (var i = 1; i < slides.length; i++) {
    slide = slides[i];
    if (slide.properties.continued === "true" || slide.properties.count === "false") {
      els[i - 1].className += ' has-continuation';
    }
  }
  var s = d.createElement("style");
  s.type = "text/css"; s.innerHTML = "@media print { .has-continuation { display: none; } }";
  d.head.appendChild(s);
})(document);
// delete the temporary CSS (for displaying all slides initially) when the user
// starts to view slides
(function() {
  var deleted = false;
  slideshow.on('beforeShowSlide', function(slide) {
    if (deleted) return;
    var sheets = document.styleSheets, node;
    for (var i = 0; i < sheets.length; i++) {
      node = sheets[i].ownerNode;
      if (node.dataset["target"] !== "print-only") continue;
      node.parentNode.removeChild(node);
    }
    deleted = true;
  });
})();</script>

<script>
(function() {
  var links = document.getElementsByTagName('a');
  for (var i = 0; i < links.length; i++) {
    if (/^(https?:)?\/\//.test(links[i].getAttribute('href'))) {
      links[i].target = '_blank';
    }
  }
})();
</script>

  </body>
</html>
